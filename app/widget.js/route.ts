import { NextResponse } from "next/server"
import { createAdminClient } from "@/lib/supabase/admin"

// Hugeicons Bulk Rounded SVGs
const iconSvgs: Record<string, string> = {
  "ai-brain": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path fill="currentColor" opacity="0.4" d="M3.414,15.399 C2.136,14.802 1.25,13.505 1.25,12 C1.25,10.495 2.136,9.198 3.414,8.601 C3.308,8.252 3.25,7.883 3.25,7.5 C3.25,5.66 4.575,4.13 6.323,3.811 C6.639,2.347 7.942,1.25 9.5,1.25 C11.295,1.25 12.75,2.705 12.75,4.5 L12.75,19.5 C12.75,21.295 11.295,22.75 9.5,22.75 C7.942,22.75 6.639,21.653 6.323,20.189 C4.575,19.87 3.25,18.34 3.25,16.5 C3.25,16.117 3.308,15.748 3.414,15.399 Z" /><path fill="currentColor" d="M12,21.577 C12.468,21.014 12.75,20.29 12.75,19.5 C12.75,20.466 13.533,21.25 14.5,21.25 C15.467,21.25 16.25,20.466 16.25,19.5 C16.25,18.928 15.976,18.42 15.55,18.1 C15.218,17.851 15.152,17.381 15.4,17.049 C15.649,16.718 16.119,16.651 16.45,16.9 C17.022,17.33 17.449,17.945 17.64,18.658 C18.571,18.382 19.25,17.52 19.25,16.5 C19.25,16.072 19.131,15.675 18.926,15.335 C18.798,15.125 18.782,14.866 18.882,14.642 C18.981,14.417 19.185,14.256 19.426,14.21 C20.465,14.011 21.25,13.096 21.25,12 C21.25,11.064 20.678,10.26 19.864,9.921 C19.439,10.423 18.884,10.812 18.25,11.036 C17.859,11.175 17.431,10.97 17.293,10.579 C17.155,10.189 17.36,9.76 17.75,9.622 C18.243,9.448 18.658,9.106 18.926,8.665 C19.131,8.325 19.25,7.928 19.25,7.5 C19.25,6.257 18.243,5.25 17,5.25 C16.586,5.25 16.25,4.914 16.25,4.5 C16.25,3.533 15.467,2.75 14.5,2.75 C13.533,2.75 12.75,3.533 12.75,4.5 C12.75,3.71 12.468,2.986 12,2.423 C12.596,1.706 13.495,1.25 14.5,1.25 C16.059,1.25 17.361,2.347 17.677,3.811 C19.425,4.13 20.75,5.66 20.75,7.5 C20.75,7.883 20.692,8.252 20.586,8.601 C21.864,9.198 22.75,10.495 22.75,12 C22.75,13.505 21.864,14.802 20.586,15.399 C20.692,15.748 20.75,16.117 20.75,16.5 C20.75,18.34 19.425,19.871 17.677,20.189 C17.361,21.653 16.059,22.75 14.5,22.75 C13.495,22.75 12.596,22.294 12,21.577 Z" /></svg>',
  "chatbot": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path fill="currentColor" opacity="0.4" d="M13.055,7.25 C14.422,7.25 15.525,7.25 16.392,7.367 C17.292,7.488 18.05,7.746 18.652,8.348 C19.254,8.95 19.512,9.708 19.634,10.608 C19.75,11.475 19.75,12.687 19.75,14.055 L19.75,14.055 C19.75,15.422 19.75,16.525 19.634,17.392 C19.512,18.292 19.254,19.05 18.652,19.652 C18.05,20.254 17.292,20.512 16.392,20.634 C15.525,20.75 14.422,20.75 13.055,20.75 L13.055,20.75 L12.482,20.75 C12.342,20.99 12.129,21.278 11.811,21.561 C11.089,22.202 9.902,22.75 8,22.75 C7.697,22.75 7.424,22.568 7.308,22.288 C7.191,22.009 7.254,21.687 7.467,21.472 C7.546,21.379 7.77,21.114 7.874,20.956 C7.935,20.865 7.99,20.773 8.038,20.681 C6.934,20.585 6.035,20.338 5.348,19.652 C4.746,19.05 4.488,18.292 4.367,17.392 C4.25,16.525 4.25,15.422 4.25,14.055 L4.25,14.055 C4.25,12.687 4.25,11.475 4.367,10.608 C4.488,9.708 4.746,8.95 5.348,8.348 C5.95,7.746 6.708,7.488 7.608,7.367 C8.475,7.25 9.578,7.25 10.945,7.25 L10.945,7.25 L13.055,7.25 L13.055,7.25 Z" /><path fill="currentColor" d="M12,1.25 C13.243,1.25 14.25,2.257 14.25,3.5 C14.25,4.48 13.624,5.313 12.75,5.622 L12.75,7.25 L11.25,7.25 L11.25,5.622 C10.376,5.313 9.75,4.48 9.75,3.5 C9.75,2.257 10.757,1.25 12,1.25 Z M2.375,11.055 C2.604,10.922 2.843,10.852 3.086,10.812 C3,11.743 3,12.988 3,14.134 L3,14.134 C3,15.275 3,16.315 3.085,17.194 C2.842,17.154 2.604,17.084 2.375,16.952 C2.033,16.754 1.749,16.47 1.551,16.128 C1.374,15.821 1.308,15.495 1.278,15.166 C1.25,14.855 1.25,14.476 1.25,14.036 L1.25,14.035 C1.25,13.595 1.25,13.152 1.278,12.84 C1.308,12.511 1.374,12.185 1.551,11.878 C1.749,11.536 2.033,11.252 2.375,11.055 Z M20.915,17.194 C21.001,16.315 21.001,15.275 21,14.134 C21.001,12.988 21.001,11.743 20.914,10.812 C21.157,10.852 21.397,10.922 21.625,11.055 C21.968,11.252 22.252,11.536 22.449,11.878 C22.626,12.185 22.692,12.511 22.722,12.84 C22.75,13.152 22.75,13.596 22.75,14.035 L22.75,14.035 C22.75,14.475 22.75,14.855 22.722,15.166 C22.692,15.495 22.626,15.821 22.449,16.128 C22.252,16.47 21.968,16.754 21.625,16.952 C21.397,17.084 21.158,17.154 20.915,17.194 Z M9.4,16.05 C9.646,15.722 10.109,15.653 10.44,15.893 C10.492,15.922 10.635,16 10.763,16.048 C11.018,16.143 11.429,16.25 12,16.25 C12.571,16.25 12.982,16.143 13.237,16.048 C13.365,16 13.508,15.922 13.56,15.893 C13.891,15.653 14.354,15.722 14.6,16.05 C14.849,16.381 14.781,16.851 14.45,17.1 L14.434,17.111 C14.388,17.141 14.293,17.204 14.243,17.232 C14.128,17.296 13.969,17.375 13.763,17.452 C13.352,17.607 12.763,17.75 12,17.75 C11.238,17.75 10.649,17.607 10.237,17.452 C10.031,17.375 9.872,17.296 9.757,17.232 C9.707,17.204 9.612,17.141 9.566,17.111 L9.55,17.1 C9.219,16.851 9.152,16.381 9.4,16.05 Z M9.75,12 L9.75,13 C9.75,13.414 9.414,13.75 9,13.75 C8.586,13.75 8.25,13.414 8.25,13 L8.25,12 C8.25,11.586 8.586,11.25 9,11.25 C9.414,11.25 9.75,11.586 9.75,12 Z M15.75,12 L15.75,13 C15.75,13.414 15.414,13.75 15,13.75 C14.586,13.75 14.25,13.414 14.25,13 L14.25,12 C14.25,11.586 14.586,11.25 15,11.25 C15.414,11.25 15.75,11.586 15.75,12 Z" /></svg>',
  "bubble-spark": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path opacity="0.4" d="M12 22.25C17.661 22.25 22.25 17.66 22.25 12C22.25 6.34 17.661 1.75 12 1.75C6.339 1.75 1.75 6.34 1.75 12C1.75 13.13 1.933 14.22 2.271 15.24C2.71 16.55 2.436 18.1699 2.076 19.1299L2.00301 19.3101C1.80201 19.7901 1.84801 20.4101 2.27901 20.8401C2.55401 21.1101 2.95601 21.27 3.37801 21.21C3.71701 21.16 4.054 21.05 4.341 20.96L4.358 20.95C4.667 20.86 4.94499 20.77 5.23599 20.71C5.78199 20.61 6.385 20.62 7.145 21.03C8.59 21.81 10.245 22.25 12 22.25Z" fill="currentColor" /><path d="M12.7687 7.87857C12.6077 7.08857 11.5457 7.03867 11.2727 7.72867L11.2297 7.87857C10.9067 9.45857 9.72675 10.7186 8.18975 11.1486L7.87775 11.2287C7.04075 11.3987 7.04075 12.5987 7.87775 12.7687C9.56575 13.1087 10.8847 14.4288 11.2297 16.1188C11.4007 16.9588 12.5977 16.9588 12.7687 16.1188C13.1137 14.4288 14.4327 13.1087 16.1207 12.7687C16.9587 12.5987 16.9587 11.3987 16.1207 11.2287C14.4327 10.8887 13.1137 9.56857 12.7687 7.87857Z" fill="currentColor" /></svg>',
  "ai": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path fill="currentColor" opacity="0.4" d="M5.25,17.374 C3.122,15.729 1.75,13.15 1.75,10.25 C1.75,5.279 5.779,1.25 10.75,1.25 C15.643,1.25 19.624,5.155 19.747,10.018 L22.124,13.584 C22.243,13.763 22.28,13.985 22.225,14.193 C22.17,14.4 22.028,14.575 21.835,14.671 L20.2,15.488 L20.042,16.914 C19.898,18.213 18.805,19.164 17.755,19.683 C16.85,20.131 16.25,20.831 16.25,21.5 L16.25,22 C16.25,22.414 15.914,22.75 15.5,22.75 L6,22.75 C5.586,22.75 5.25,22.414 5.25,22 L5.25,17.374 Z" /><path fill="currentColor" d="M7.747,7.248 C7.948,6.626 8.54,6.25 9.154,6.25 C9.768,6.25 10.36,6.626 10.561,7.248 L12.022,11.769 C12.149,12.164 11.933,12.586 11.538,12.714 C11.144,12.841 10.722,12.625 10.594,12.231 L10.277,11.25 L8.031,11.25 L7.714,12.231 C7.587,12.625 7.164,12.841 6.77,12.714 C6.375,12.586 6.159,12.164 6.287,11.769 Z M14,6.25 C14.414,6.25 14.75,6.586 14.75,7 L14.75,12 C14.75,12.414 14.414,12.75 14,12.75 C13.586,12.75 13.25,12.414 13.25,12 L13.25,7 C13.25,6.586 13.586,6.25 14,6.25 Z M8.515,9.75 L9.793,9.75 L9.154,7.773 Z" /></svg>',
  "ai-magic": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path fill="currentColor" opacity="0.4" d="M10,6.25 C9.686,6.25 9.406,6.445 9.297,6.74 L8.781,8.134 C8.081,10.026 7.796,10.749 7.272,11.273 C6.749,11.796 6.026,12.081 4.134,12.781 L2.74,13.297 C2.445,13.405 2.25,13.686 2.25,14 C2.25,14.314 2.445,14.595 2.74,14.703 L4.134,15.219 C6.026,15.919 6.749,16.204 7.272,16.727 C7.796,17.251 8.081,17.974 8.781,19.866 L9.297,21.26 C9.406,21.555 9.686,21.75 10,21.75 C10.314,21.75 10.595,21.555 10.703,21.26 L11.219,19.866 C11.919,17.974 12.204,17.251 12.727,16.727 C13.251,16.204 13.974,15.919 15.866,15.219 L17.26,14.703 C17.555,14.595 17.75,14.314 17.75,14 C17.75,13.686 17.555,13.405 17.26,13.297 L15.866,12.781 C13.974,12.081 13.251,11.796 12.727,11.273 C12.204,10.749 11.919,10.026 11.219,8.134 L10.703,6.74 C10.595,6.445 10.314,6.25 10,6.25 Z" /><path fill="currentColor" d="M18,2.25 C17.686,2.25 17.405,2.445 17.297,2.74 L17.076,3.337 C16.762,4.185 16.671,4.385 16.528,4.528 C16.386,4.671 16.185,4.762 15.337,5.076 L14.74,5.297 C14.445,5.406 14.25,5.686 14.25,6 C14.25,6.314 14.445,6.594 14.74,6.703 L15.337,6.924 C16.185,7.238 16.386,7.329 16.528,7.472 C16.671,7.615 16.762,7.815 17.076,8.663 L17.297,9.26 C17.405,9.555 17.686,9.75 18,9.75 C18.314,9.75 18.595,9.555 18.703,9.26 L18.924,8.663 C19.238,7.815 19.329,7.615 19.472,7.472 C19.614,7.329 19.815,7.238 20.663,6.924 L21.26,6.703 C21.555,6.594 21.75,6.314 21.75,6 C21.75,5.686 21.555,5.406 21.26,5.297 L20.663,5.076 C19.815,4.762 19.614,4.671 19.472,4.528 C19.329,4.385 19.238,4.185 18.924,3.337 L18.703,2.74 C18.595,2.445 18.314,2.25 18,2.25 Z" /></svg>',
  "support": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path fill="currentColor" opacity="0.4" d="M4.014,8.505 C4.363,8.309 4.765,8.224 5.163,8.257 C5.52,8.286 6.011,8.51 6.374,8.676 C6.73,8.835 7.402,9.135 7.658,9.892 C7.751,10.167 7.75,10.462 7.749,10.735 L7.749,15.265 C7.75,15.538 7.751,15.833 7.658,16.108 C7.402,16.865 6.73,17.165 6.374,17.324 C6.011,17.49 5.52,17.714 5.163,17.743 C4.765,17.775 4.363,17.691 4.014,17.495 C3.697,17.317 3.459,17.027 3.218,16.732 C3.131,16.626 2.966,16.432 2.85,16.298 L2.85,16.298 C2.638,16.052 2.397,15.773 2.199,15.514 C1.871,15.085 1.543,14.571 1.38,13.974 C1.205,13.335 1.205,12.665 1.38,12.026 C1.498,11.593 1.712,11.21 1.995,10.809 C2.269,10.42 2.735,9.851 3.191,9.297 L3.191,9.297 L3.191,9.297 C3.265,9.204 3.366,9.076 3.44,8.99 C3.576,8.835 3.763,8.646 4.014,8.505 Z M19.985,8.505 C20.236,8.646 20.423,8.835 20.558,8.99 C20.633,9.076 20.734,9.204 20.807,9.297 L20.807,9.297 C21.263,9.851 21.73,10.42 22.003,10.809 C22.286,11.21 22.5,11.593 22.618,12.026 C22.793,12.665 22.793,13.335 22.618,13.974 C22.455,14.571 22.127,15.085 21.799,15.514 C21.601,15.773 21.361,16.052 21.149,16.298 C21.033,16.432 20.868,16.626 20.781,16.732 C20.54,17.027 20.302,17.317 19.985,17.495 C19.635,17.691 19.233,17.775 18.836,17.743 C18.478,17.714 17.987,17.49 17.625,17.324 C17.268,17.165 16.597,16.865 16.341,16.108 C16.248,15.833 16.249,15.538 16.249,15.264 L16.249,10.736 C16.249,10.462 16.248,10.167 16.341,9.892 C16.597,9.135 17.268,8.835 17.625,8.676 C17.987,8.51 18.478,8.286 18.836,8.257 C19.233,8.224 19.635,8.309 19.985,8.505 Z" /><path fill="currentColor" d="M11.999,4 C8.748,4 6.314,6.095 6.027,8.521 C5.734,8.395 5.415,8.277 5.163,8.257 C4.767,8.225 4.367,8.309 4.019,8.503 C4.312,4.75 7.91,2 11.999,2 C16.089,2 19.686,4.749 19.98,8.502 C19.632,8.309 19.232,8.225 18.836,8.257 C18.583,8.277 18.264,8.395 17.971,8.521 C17.685,6.095 15.251,4 11.999,4 Z M17.999,17.802 L17.999,17.493 C18.285,17.614 18.591,17.725 18.836,17.745 C19.233,17.777 19.635,17.692 19.985,17.497 L19.999,17.488 L19.999,17.802 C19.999,20.318 17.541,22.002 14.999,22.002 L12.999,22.002 C12.447,22.002 11.999,21.554 11.999,21.002 C11.999,20.449 12.447,20.002 12.999,20.002 L14.999,20.002 C16.876,20.002 17.999,18.82 17.999,17.802 Z" /></svg>',
  "question": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path fill="currentColor" opacity="0.4" d="M14.219,1.817 C12.759,1.728 11.239,1.728 9.779,1.817 C5.209,2.127 1.589,5.808 1.289,10.418 C1.239,11.277 1.239,12.178 1.289,13.037 C1.399,14.758 2.149,16.297 2.979,17.557 C3.229,18.037 3.099,18.758 2.639,19.648 L2.619,19.688 C2.459,19.988 2.309,20.277 2.219,20.517 C2.119,20.788 2.029,21.197 2.269,21.607 C2.489,21.987 2.839,22.128 3.129,22.188 C3.369,22.227 3.659,22.238 3.939,22.247 L3.979,22.247 C5.399,22.277 6.399,21.867 7.189,21.288 C7.349,21.168 7.459,21.087 7.539,21.038 C7.659,21.078 7.819,21.148 8.059,21.238 C8.599,21.468 9.209,21.598 9.779,21.637 C11.239,21.738 12.759,21.738 14.219,21.637 C18.789,21.337 22.409,17.648 22.709,13.037 C22.759,12.178 22.759,11.277 22.709,10.418 C22.409,5.808 18.789,2.127 14.219,1.817 Z" /><path fill="currentColor" d="M12.018,8.5 C11.338,8.5 11.018,8.96 11.018,9.26 C11.018,9.81 10.568,10.26 10.018,10.26 C9.468,10.26 9.018,9.81 9.018,9.26 C9.018,7.62 10.488,6.5 12.018,6.5 C13.548,6.5 15.018,7.62 15.018,9.26 C15.018,9.84 14.818,10.37 14.508,10.8 C14.318,11.05 14.108,11.29 13.918,11.49 C13.888,11.53 13.848,11.57 13.818,11.6 C13.668,11.77 13.528,11.92 13.408,12.07 C13.078,12.46 13.018,12.66 13.018,12.77 L13.018,13.21 C13.018,13.77 12.568,14.21 12.018,14.21 C11.468,14.21 11.018,13.77 11.018,13.21 L11.018,12.77 C11.018,11.92 11.488,11.24 11.858,10.8 C12.028,10.6 12.198,10.41 12.358,10.24 C12.388,10.21 12.418,10.17 12.448,10.14 C12.628,9.94 12.778,9.77 12.888,9.62 C12.978,9.5 13.018,9.38 13.018,9.26 C13.018,8.96 12.698,8.5 12.018,8.5 Z M11.018,16.5 C11.018,15.95 11.468,15.5 12.018,15.5 L12.028,15.5 C12.578,15.5 13.028,15.95 13.028,16.5 C13.028,17.05 12.578,17.5 12.028,17.5 L12.018,17.5 C11.468,17.5 11.018,17.05 11.018,16.5 Z" /></svg>',
  "chat": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"><path opacity="0.4" d="M12 22.2539C17.661 22.2539 22.25 17.6648 22.25 12.0039C22.25 6.34299 17.661 1.75391 12 1.75391C6.339 1.75391 1.75 6.34299 1.75 12.0039C1.75 13.1335 1.933 14.222 2.271 15.2402C2.71 16.5575 2.436 18.1753 2.076 19.1357L2.00301 19.3184C1.80201 19.7919 1.84801 20.4122 2.27901 20.8437C2.55401 21.1186 2.95601 21.2748 3.37801 21.2109C3.71701 21.1597 4.054 21.0532 4.341 20.9625L4.358 20.957C4.667 20.8595 4.94499 20.7727 5.23599 20.7178C5.78199 20.6151 6.385 20.624 7.145 21.0332C8.59 21.8123 10.245 22.2539 12 22.2539Z" fill="currentColor" /><path d="M8.01877 11.0039L8.12077 11.0088C8.62477 11.06 9.01877 11.4862 9.01877 12.0039C9.01877 12.5216 8.62477 12.9478 8.12077 12.999L8.01877 13.0039H8.00977C7.45677 13.0039 7.00977 12.5562 7.00977 12.0039C7.00977 11.4516 7.45677 11.0039 8.00977 11.0039H8.01877ZM12.0148 11.0039C12.5668 11.0041 13.0148 11.4518 13.0148 12.0039C13.0148 12.556 12.5668 13.0037 12.0148 13.0039H12.0048C11.4528 13.0037 11.0048 12.5561 11.0048 12.0039C11.0048 11.4517 11.4528 11.0041 12.0048 11.0039H12.0148ZM16.0098 11.0039C16.5618 11.0039 17.0098 11.4516 17.0098 12.0039C17.0098 12.5562 16.5618 13.0039 16.0098 13.0039H16.0008C15.4488 13.0039 15.0008 12.5562 15.0008 12.0039C15.0008 11.4516 15.4488 11.0039 16.0008 11.0039H16.0098Z" fill="currentColor" /></svg>',
}

const defaultIcon = iconSvgs["chat"]
const closeIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'

// Serverer widget scriptet til embedding på eksterne sider
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const agentId = searchParams.get("agent")
  
  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || "http://localhost:3000"

  // Hent agent branding fra database
  let primaryColor = "#0d9488"
  let iconSvg = defaultIcon

  if (agentId) {
    try {
      const supabase = createAdminClient()
      const { data: agent } = await supabase
        .from("agents")
        .select("branding")
        .eq("id", agentId)
        .single()

      if (agent?.branding) {
        primaryColor = agent.branding.primary_color || primaryColor
        const iconId = agent.branding.icon_id || "chat"
        iconSvg = iconSvgs[iconId] || defaultIcon
      }
    } catch (e) {
      // Brug default værdier ved fejl
    }
  }

  const script = `
(function() {
  // Undgå at køre flere gange
  if (window.__easybotLoaded) return;
  window.__easybotLoaded = true;

  var agentId = "${agentId || ""}";
  var baseUrl = "${siteUrl}";
  var primaryColor = "${primaryColor}";
  var openIcon = '${iconSvg}';
  var closeIcon = '${closeIcon}';

  // Opret container
  var container = document.createElement("div");
  container.id = "easybot-widget-container";
  container.style.cssText = "position:fixed;bottom:20px;right:20px;z-index:999999;font-family:system-ui,-apple-system,sans-serif;";
  document.body.appendChild(container);

  // State
  var isOpen = false;
  var iframe = null;

  // Opret chat button
  var button = document.createElement("button");
  button.id = "easybot-toggle";
  button.innerHTML = openIcon;
  button.style.cssText = "width:56px;height:56px;border-radius:50%;border:none;background:" + primaryColor + ";color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:transform 0.2s,box-shadow 0.2s;";
  button.onmouseenter = function() { button.style.transform = "scale(1.05)"; button.style.boxShadow = "0 6px 16px rgba(0,0,0,0.2)"; };
  button.onmouseleave = function() { button.style.transform = "scale(1)"; button.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)"; };
  container.appendChild(button);

  // Opret chat window container
  var chatWindow = document.createElement("div");
  chatWindow.id = "easybot-chat-window";
  chatWindow.style.cssText = "position:absolute;bottom:70px;right:0;width:380px;height:550px;max-height:calc(100vh - 100px);background:white;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.15);overflow:hidden;display:none;flex-direction:column;";
  container.appendChild(chatWindow);

  // Toggle chat
  button.onclick = function() {
    isOpen = !isOpen;
    if (isOpen) {
      chatWindow.style.display = "flex";
      button.innerHTML = closeIcon;
      
      // Lazy load iframe
      if (!iframe) {
        iframe = document.createElement("iframe");
        iframe.src = baseUrl + "/widget/chat?agent=" + agentId;
        iframe.style.cssText = "width:100%;height:100%;border:none;";
        iframe.allow = "microphone";
        chatWindow.appendChild(iframe);
      }
    } else {
      chatWindow.style.display = "none";
      button.innerHTML = openIcon;
    }
  };

  // Responsiv på mobil
  function handleResize() {
    if (window.innerWidth < 480) {
      chatWindow.style.width = "calc(100vw - 40px)";
      chatWindow.style.height = "calc(100vh - 100px)";
      chatWindow.style.right = "-10px";
    } else {
      chatWindow.style.width = "380px";
      chatWindow.style.height = "550px";
      chatWindow.style.right = "0";
    }
  }
  window.addEventListener("resize", handleResize);
  handleResize();
})();
`

  return new NextResponse(script, {
    headers: {
      "Content-Type": "application/javascript",
      "Cache-Control": "public, max-age=300", // Kortere cache for at opdatere branding hurtigere
      "Access-Control-Allow-Origin": "*",
    },
  })
}
